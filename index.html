<!DOCTYPE html>
<html>
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="/js/hashtable.js"></script>
    <script src="/js/jquery.numberformatter-1.2.4.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load('visualization', '1.0', {'packages':['corechart']})
    </script>
    <style type="text/css">
        thead {
            background-color: gray;
            color: white;
        }
        th, td {
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="socket-buttons">
        <!--<button data-command="test">Test</button>-->        
    </div>
    <div id="segments">
    </div>
    <div id="current-segment-display">
    </div>
</body>
<script>
    var socket = io();
    
    $('#socket-buttons > button').on('click', function(){
        socket.emit($(this).data('command'));
    });
    socket.on('test', ConsoleLog);
    //socket.on('segments', DisplaySegments);
    socket.on('current-segment-data', DisplayCurrentSegmentData);
    
    function SELECT(){ return $('<select>'); }
    function OPTION(value, display){
        display = display || value;
        return $('<option>')
            .attr('value', value)
            .text(display);
    }
    function TABLE(){ return $('<table>'); }
    function TR(){ return $('<tr>'); }
    function TD(){ return $('<td>'); }
    function TH(){ return $('<th>'); }
    function TBODY(){ return $('<tbody>'); }
    function THEAD(){ return $('<thead>'); }
    
    function DisplaySegments(segments){
        var $segments = $('#segments');
        $segments.empty();
        
        var $select = SELECT();
        for(var i = 0; i < segments.length; i++){
            var segment = segments[i];
            var segmentDescription = segment.startTime + ' - ' + segment.endTime + ' - ' + segment.durationDescription + ' (' + segment.lines + ')';
            $select.append(OPTION(segment.id, segmentDescription));
        }
        $select.appendTo($segments);
        
        var $button = $('<button>')
            .text('Get Data')
            .appendTo($segments);
            
        $button.on('click', function(){
            var segmentId = $select.val();
            socket.emit('subscribe', segmentId);
        });
    }
    
    function ColumnDefinition(selector, header){
        this.selector = selector;
        this.header = header;
    }
    
    function TableOfArray(data, columns){
        var $table = TABLE();
        
        if(columns){
            var $thead = THEAD().appendTo($table);
            var $theadr = TR().appendTo($thead);
            for(var i = 0; i < columns.length; i++){
                var col = columns[i];
                TH().text(col.header).appendTo($theadr);
            }
            var $tbody = TBODY().appendTo($table);
            
            if(data){
                for(var i = 0; i < data.length; i++){
                    var row = data[i];
                    if(row){
                        var $row = TR().appendTo($tbody);
                        for(var j = 0; j < columns.length; j++){
                            var col = columns[j];
                            TD().text(col.selector(row)).appendTo($row);
                        }
                    }
                }
            }
            
        }
        return $table;
    }
    
    function FormatNumber(number){
        return $.formatNumber(number, { format: '#,##0.0' });
    }
    
    function DisplaySegmentData(data, element){
        $(element).empty()
            .append(TableOfArray(
                data.playerData.sort(function(a,b){
                    return (b && b.totalDamage || 0) - (a && a.totalDamage || 0);
                }), [
                new ColumnDefinition(function(row){ return row.player.display; }, 'Player'),
                new ColumnDefinition(function(row){ return FormatNumber(row.totalDamage); }, 'Damage'),
                new ColumnDefinition(function(row){ return FormatNumber(row.dps); }, 'DPS'),
                new ColumnDefinition(function(row){ return FormatNumber(row.totalHealing); }, 'Healing'),
                new ColumnDefinition(function(row){ return Math.round(row.time / 1000); }, 'Time'),
            ]))
            .css({
                'font-family': 'monospace',
                'text-align': 'right',
            });
    }
    
    function DisplayCurrentSegmentData(data){
        DisplaySegmentData(data, '#current-segment-display');
    }
    
    function ConsoleLog(data){
        console.log(Date.now(), data);
    }
    
</script>
</html>